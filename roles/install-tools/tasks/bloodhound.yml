
---
# roles/install-tools/tasks/bloodhound.yml

- name: Map CPU architecture to bloodhound-cli release arch
  ansible.builtin.set_fact:
    bhcli_arch: >-
      {{ 'amd64' if ansible_architecture in ['x86_64', 'amd64'] else
         'arm64' if ansible_architecture in ['aarch64', 'arm64'] else
         'amd64' }}

- name: Determine target user for running bloodhound-cli
  ansible.builtin.set_fact:
    bloodhound_user: "{{ bloodhound_user | default(ansible_user_id) }}"
    bloodhound_install_dir: "{{ bloodhound_install_dir | default('/opt/bloodhound') }}"
    bloodhound_pwd_file: "{{ bloodhound_pwd_file | default('/root/bloodhound_ce_admin_password.txt') }}"
    bloodhound_show_password: "{{ bloodhound_show_password | default(false) }}"
    install_docker: "{{ install_docker | default(true) }}"

- name: Get passwd entry for bloodhound_user (home dir)
  ansible.builtin.getent:
    database: passwd
    key: "{{ bloodhound_user }}"

- name: Set BloodHound CLI config directory (XDG default)
  ansible.builtin.set_fact:
    bloodhound_config_dir: "{{ getent_passwd[bloodhound_user][4] }}/.config/bloodhound"

# -------------------------------------------------------------------------
# Docker installation (Kali/Debian family)
# -------------------------------------------------------------------------
- name: Check if docker-compose-plugin exists in apt repo
  ansible.builtin.shell: "apt-cache show docker-compose-plugin >/dev/null 2>&1"
  args:
    executable: /bin/bash
  register: bh_has_compose_plugin
  changed_when: false
  failed_when: false
  when: install_docker

- name: Install Docker + Compose (plugin if available, else docker-compose)
  ansible.builtin.apt:
    update_cache: true
    name: >-
      {{
        ['docker.io', 'ca-certificates', 'curl']
        + (['docker-compose-plugin'] if (bh_has_compose_plugin.rc == 0) else ['docker-compose'])
      }}
    state: present
  when: install_docker

- name: Ensure docker group exists
  ansible.builtin.group:
    name: docker
    state: present
  when: install_docker

- name: Add bloodhound_user to docker group
  ansible.builtin.user:
    name: "{{ bloodhound_user }}"
    groups: docker
    append: true
  when: install_docker

- name: Ensure Docker service is enabled and running
  ansible.builtin.service:
    name: docker
    enabled: true
    state: started
  when: install_docker

- name: Verify Docker Compose is available (either plugin or standalone)
  ansible.builtin.shell: |
    set -e
    if docker compose version >/dev/null 2>&1; then
      docker compose version
    else
      docker-compose version
    fi
  args:
    executable: /bin/bash
  changed_when: false
  when: install_docker

# -------------------------------------------------------------------------
# Download + install bloodhound-cli (latest)
# -------------------------------------------------------------------------
- name: Ensure staging directory exists
  ansible.builtin.file:
    path: "{{ bloodhound_install_dir }}"
    state: directory
    mode: "0755"

- name: Download bloodhound-cli tarball (latest)
  ansible.builtin.get_url:
    url: "https://github.com/SpecterOps/bloodhound-cli/releases/latest/download/bloodhound-cli-linux-{{ bhcli_arch }}.tar.gz"
    dest: "{{ bloodhound_install_dir }}/bloodhound-cli-linux-{{ bhcli_arch }}.tar.gz"
    mode: "0644"

- name: Unpack bloodhound-cli
  ansible.builtin.unarchive:
    src: "{{ bloodhound_install_dir }}/bloodhound-cli-linux-{{ bhcli_arch }}.tar.gz"
    dest: "{{ bloodhound_install_dir }}"
    remote_src: true
    creates: "{{ bloodhound_install_dir }}/bloodhound-cli"

- name: Install bloodhound-cli into /usr/local/bin
  ansible.builtin.copy:
    src: "{{ bloodhound_install_dir }}/bloodhound-cli"
    dest: /usr/local/bin/bloodhound-cli
    mode: "0755"
    remote_src: true

# -------------------------------------------------------------------------
# Run install idempotently (Option A)
# -------------------------------------------------------------------------
- name: Check whether BloodHound config dir exists
  ansible.builtin.stat:
    path: "{{ bloodhound_config_dir }}"
  register: bh_cfg

- name: Check whether docker-compose.yml exists in BH config dir
  ansible.builtin.stat:
    path: "{{ bloodhound_config_dir }}/docker-compose.yml"
  register: bh_compose
  when: bh_cfg.stat.exists

- name: Run bloodhound-cli install (first-time setup only)
  ansible.builtin.command: /usr/local/bin/bloodhound-cli install
  become_user: "{{ bloodhound_user }}"
  register: bh_install
  changed_when: true
  when: not (bh_cfg.stat.exists and (bh_compose.stat.exists | default(false)))

# -------------------------------------------------------------------------
# Retrieve generated password and persist it
# -------------------------------------------------------------------------
- name: Try reading generated default password from CLI config (if supported)
  ansible.builtin.command: /usr/local/bin/bloodhound-cli config get default_password
  become_user: "{{ bloodhound_user }}"
  register: bh_default_pwd
  changed_when: false
  failed_when: false
  no_log: true

- name: Persist generated password to root-only file
  ansible.builtin.copy:
    dest: "{{ bloodhound_pwd_file }}"
    content: |
      BloodHound CE initial admin credentials
      username: admin
      password: {{ bh_default_pwd.stdout | trim }}
      UI: http://localhost:8080/ui/login
    mode: "0600"
  when: bh_default_pwd.rc == 0 and (bh_default_pwd.stdout | trim | length) > 0
  no_log: true

- name: Optionally display the password (WILL show in output!)
  ansible.builtin.debug:
    msg: "BloodHound CE admin password: {{ bh_default_pwd.stdout | trim }}"
  when:
    - bloodhound_show_password | bool
    - bh_default_pwd.rc == 0
    - (bh_default_pwd.stdout | trim | length) > 0
  no_log: false

- name: Show access info (no password)
  ansible.builtin.debug:
    msg:
      - "BloodHound CE UI: http://localhost:8080/ui/login"
      - "If retrieved, the initial admin password is saved to: {{ bloodhound_pwd_file }}"

